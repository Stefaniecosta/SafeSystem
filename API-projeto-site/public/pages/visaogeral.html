<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/visaogeral.css">
    <script src="https://kit.fontawesome.com/6f2d70ffaf.js" crossorigin="anonymous"></script>
    <title>Visão Geral</title>
</head>

<body>
    <div id="content">
        <img id="logoName" src="../assets/img/logoss.svg" alt="">

        <div id="options">
            <div class="item">
                <strong class="font_tamanho">
                    Caixas
                </strong>
            </div>

            <hr>

            <div class="item">
                <div>
                    <img src="../assets/img/visaoGeralImg.png" alt="">
                </div>
                <a href="visaogeral.html"> VISÃO GERAL </a>
            </div>




        </div>

        <!-- Ícone de SAIR da dashboard -->
        <div id="logout">
            <a href="/Site/index.html">
                <img id="logoutIcon" src="../assets/img/logoutIcon.png" alt="Ícone para sair da Dashboard">
            </a>
        </div>
    </div>

    <div id="informations">
        <header class="header">
            <strong class="item_color">Dashboard</strong>

            <div class="dropdown">
                <button class="dropbtn">
                    <img id="user" src="../assets/img/user.png" alt="">
                    <div class="dropdown-content">
                        <a href="../pages/dashPerfil.html">Perfil</a>
                        <a href="/Site/index.html">Homepage</a>
                        <a href="../pages/visaogeral.html">Visão Geral</a>
                    </div>
                </button>
            </div>
            <button id="repError">REPORTAR ERRO</button>
        </header>

        <div class="container-boxes">
            <div id="boxDasCaixas" class="aux-container-boxes">
                <!-- <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">

                                <strong>
                                    <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                    Caixa 1
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status:
                                <i class="fas fa-skull"></i> <b class="critico"> CRÍTICO</b>
                            </div>
                            <p style="color: rgba(255, 126, 120, 0.8);">DISPOSITIVO <br> ESTRANHO</p>
                        </div>
                    </div>
                </div>
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa 2
                                </strong>
                            </div>
                            <br>
                            <div id="iconeTwo" class="icone">
                                Status:
                                <i class="fas fa-exclamation-triangle"></i> <b class="alerta"> ALERTA</b>
                            </div>
                            <p style="color: rgba(244, 219, 87, 0.8);"> MUITOS COMPONENTES <br> LENTOS</p>
                        </div>
                    </div>
                </div>
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa 3
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status: <b class="ok"> OK</b>
                            </div>
                            <p style="color: rgba(107, 226, 190, 0.8);">ESTÁ TUDO CERTO</p>
                        </div>
                    </div>
                </div>
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa 4
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status:
                                <i class="fas fa-skull"></i> <b class="critico"> CRÍTICO</b>
                                <p style="color: rgba(255, 126, 120, 0.8);">DISPOSITIVO <br> ESTRANHO</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa 5
                                </strong>
                            </div>
                            <br>
                            <div id="iconeTwo" class="icone">
                                Status:
                                <i class="fas fa-exclamation-triangle"></i> <b class="alerta"> ALERTA</b>
                            </div>
                            <p style="color: rgba(244, 219, 87, 0.8);"> MUITOS COMPONENTES <br> LENTOS</p>
                        </div>
                    </div>
                </div>
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa 6
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status: <b class="ok"> OK</b>
                            </div>
                            <p style="color: rgba(107, 226, 190, 0.8);">ESTÁ TUDO CERTO</p>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <footer></footer>

</body>

</html>

<script>
    function armazenarIdCaixa(numero) {
        sessionStorage.setItem('idCaixaArmazenado', numero);
    }

    let quantidadeDeCaixas = 0;

    let idDasMaquinas = [];

    async function caixaAChamar(idMaquinaARodar) {
        await sessionStorage.setItem('idMaquina', idMaquinaARodar);
        window.location = 'dashboard.html';
    }

    pegarQuantidadeCaixas()

    function plotarCaixasNaTela() {
        options.innerHTML += `<hr>`;
        for (let index = 0; index < quantidadeDeCaixas; index++) {
            options.innerHTML +=
                `

            
            <div class="item" <button onclick="caixaAChamar(${idDasMaquinas[index]}), armazenarIdCaixa(${index+1})">
                <img src="../assets/img/caixaIcon.png" alt="">
                
                       <span>CAIXA <strong id="idCaixaSession">${index+1}</strong></span>  
                    </button>
                
            </div>

            <hr>
            `;
        }
        options.innerHTML +=
            `
        <div class="item item_color">
                <span>
                    Agência
                </span>
                <br>
                <strong>
                    0222
                </strong>
            </div>
            <hr>
        `;
    }



    function pegarQuantidadeCaixas() {

        const idAgencia = sessionStorage.getItem('idAgencia');

        fetch(`/agencias/obterQuantidadeDeCaixas/${idAgencia}`, {
            method: "post",
        }).then(resposta => {

            if (resposta.ok) {

                resposta.json().then(json => {

                    console.log(`Quantidade de caixas: ${json.length}`);
                    quantidadeDeCaixas = json.length;

                    for (let index = 0; index < json.length; index++) {
                        idDasMaquinas.push(json[index].idMaquina);
                    }

                    plotarCaixasNaTela();
                });

            } else {

                console.log('Erro de login!');

                resposta.text().then(texto => {
                    console.error(texto);
                    alert(texto);
                });
            }
        });
        return false;

    }

    let registros = [];

    function obterDados(idMaquina) {

        fetch(`/agencias/obterRegistrosDasMaquinas/${idMaquina}`, {
            method: "post",
        }).then(resposta => {

            if (resposta.ok) {

                resposta.json().then(json => {

                    console.log(json);
                    registros.push(json)

                });

            } else {

                console.log('Erro ao obter registro do caixa ' + idMaquina);

                resposta.text().then(texto => {
                    alert(`Erro ao obter registro do caixa ${idMaquina}`)
                });
            }
        });
        return false;

    }


    setTimeout(() => {
        obterDadosPorIdCaixa()
    }, 900);

    setTimeout(() => {
        estudarRegistros()
    }, 1100);

    setTimeout(() => {
        setInterval(() => {
            obterDadosPorIdCaixa();
            setTimeout(() => {
                boxDasCaixas.innerHTML = '';
                estudarRegistros();
            }, 200);
        }, 3800);
    }, 2100);



    async function obterDadosPorIdCaixa() {
        registros = [];
        temEstranho = []
        for (let index = 0; index < idDasMaquinas.length; index++) {
            //obterDados(idDasMaquinas[index]);
            let idMaquina = idDasMaquinas[index];
            await fetch(`/agencias/obterRegistrosDasMaquinas/${idMaquina}`, {
            method: "post",
        }).then(resposta => {

            if (resposta.ok) {

                resposta.json().then(json => {

                    console.log(json);
                    registros.push(json)

                });

            } else {

                console.log('Erro ao obter registro do caixa ' + idMaquina);

                resposta.text().then(texto => {
                    alert(`Erro ao obter registro do caixa ${idMaquina}`)
                });
            }
        });
            //obterDispositivosEstranhosVisaoGeral(idDasMaquinas[index])
            await fetch(`/agencias/obterDispositivoEstranho/${idMaquina}`, {
                method: "post",
            }).then(resposta => {
    
                if (resposta.ok) {
    
                    resposta.json().then(json => {
                      console.log('chegando dispositivos estranhos!')
                      console.log("alertando length de json: " + json.length)
                      console.log(json[0])
                      if (json == 0) {
                          temEstranho.push(false)
                      } else {
                          temEstranho.push(true)
                      }                       
                                              
                    });
    
                } else {
    
                    console.log('Erro ao obter dispositivos estranhos!');
    
                    resposta.text().then(texto => {
                        console.error(texto);
                        alert(texto);
                    });
                }
            });

        }
        console.log(registros)
        //estudarRegistros();
        console.log('atualizando dados');

    }

    function obterDispositivosEstranhosVisaoGeral(idMaquina)
    {
        temEstranho = []

        fetch(`/agencias/obterDispositivoEstranho/${idMaquina}`, {
                method: "post",
            }).then(resposta => {
    
                if (resposta.ok) {
    
                    resposta.json().then(json => {
                      console.log('chegando dispositivos estranhos!')
                      console.log("alertando length de json: " + json.length)
                      console.log(json[0])
                      if (json == 0) {
                          temEstranho.push(false)
                      } else {
                          temEstranho.push(true)
                      }                       
                                              
                    });
    
                } else {
    
                    console.log('Erro ao obter dispositivos estranhos!');
    
                    resposta.text().then(texto => {
                        console.error(texto);
                        alert(texto);
                    });
                }
            });

            return false
    }






    
    let msg = '';
    
    let temEstranho = [];

    function estudarRegistros() {
        msg = '';



        for (let index = 0; index < registros.length; index++) {

            
            if(temEstranho[index]) {
                msg = 
                `
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">

                                <strong>
                                    <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                    Caixa ${index + 1}
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status:
                                <i class="fas fa-skull"></i> <b class="critico"> CRÍTICO</b>
                            </div>
                            <p style="color: rgba(255, 126, 120, 0.8);">DISPOSITIVO <br> ESTRANHO</p>
                        </div>
                    </div>
                </div>
                `
            }else if (registros[index][0].usoRAM >= 7.0 || registros[index][0].usoCPU > 80.0) {
                msg =
                    `
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa ${index+1}
                                </strong>
                            </div>
                            <br>
                            <div id="iconeTwo" class="icone">
                                Status:
                                <i class="fas fa-exclamation-triangle"></i> <b class="alerta"> ALERTA</b>
                            </div>
                            <p style="color: rgba(244, 219, 87, 0.8);"> COMPONENTES <br> LENTOS</p>
                        </div>
                    </div>
                </div>
                `
            } else {
                msg =
                    `
                <div id="caixa" class="box">
                    <div class="boxContent">
                        <div class="info_caixas">
                            <div class="bottom">
                                <img class="item-img" src="../assets/img/caixaIcon.png" alt="">
                                <strong>
                                    Caixa ${index+1}
                                </strong>
                            </div>
                            <br>
                            <div class="icone">
                                Status: <b class="ok"> OK</b>
                            </div>
                            <p style="color: rgba(107, 226, 190, 0.8);">ESTÁ TUDO CERTO</p>
                        </div>
                    </div>
                </div>
                `
            }

            boxDasCaixas.innerHTML += msg;
            
        }

    }
</script>

